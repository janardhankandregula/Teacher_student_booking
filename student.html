<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }
      header {
        background: rgb(255, 218, 185); /* Student color */
        color: white;
        padding: 20px;
        text-align: center;
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
      }
      .container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .logout-btn {
        background-color: #dc3545; /* Logout button color */
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      .logout-btn:hover {
        background-color: #c82333; /* Darker shade on hover */
      }
      .header-container {
        display: flex;
        justify-content: space-between; /* Space between items */
        align-items: center; /* Center vertically */
      }

      .header-container h1 {
        margin: 0; /* Remove default margin */
        flex-grow: 1; /* Allow the title to take up available space */
        text-align: center; /* Center the title text */
      }
      #registrationForm {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 300px;
        margin: 0 auto;
      }
      #loginForm {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 300px;
        margin: 0 auto;
      }
      input[type="text"],
      input[type="email"],
      input[type="password"] {
        width: calc(
          100% - 22px
        ); /* Adjust width to account for padding and border */
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition: border-color 0.3s;
        box-sizing: border-box; /* Ensure padding and border are included in total width */
      }
      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="email"]:focus {
        border-color: #66afe9; /* Focus border color */
        outline: none;
      }
      .btnSubmit {
        width: calc(100% - 22px); /* Make button take full width */
        padding: 10px; /* Same padding as inputs */
        margin: 10px 0; /* Consistent margin with inputs */
        background-color: rgb(76, 175, 80); /* Button color */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        box-sizing: border-box; /* Include padding and border in width */
      }
      .btnSubmit:hover {
        background-color: #0056b3; /* Darker shade on hover */
      }
      #toggleMessage {
        cursor: pointer;
        color: blue;
        text-align: center;
        margin-top: 10px;
      }
      #formTitle {
        width: 100%; /* Make the heading take full width */
        text-align: center; /* Center text */
        margin: 0; /* Remove default margin */
        padding-bottom: 20px;
      }
      .btnSubmit2 {
        padding: 10px 15px; /* Same padding as inputs */
        background-color: rgb(76, 175, 80); /* Button color */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        box-sizing: border-box; /* Include padding and border in width */
        width: auto; /* Set the width to auto to avoid full width */
        margin: 10px auto; /* Center the button */
        display: block; /* Make it a block element for margin auto to work */
      }
      .emptyState {
        position: relative; /* Allow absolute positioning of children */
        padding: 20px; /* Add some padding for aesthetics */
        border: 1px solid #ccc; /* Optional: Add border for visibility */
        border-radius: 8px; /* Optional: Round corners */
        background-color: white; /* Background color */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Optional: Add shadow */
      }

      #searchTeacherBtn {
        position: absolute; /* Position the button absolutely */
        top: 10px; /* Adjust this value as needed */
        right: 10px; /* Adjust this value as needed */
        padding: 8px 12px; /* Adjust padding for the button */
        background-color: rgb(76, 175, 80); /* Button color */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      h2 {
        color: #333; /* Dark color for the heading */
        margin-top: 20px; /* Space above the heading */
        margin-bottom: 10px; /* Space below the heading */
        font-size: 24px; /* Font size for the heading */
      }

      ul {
        list-style-type: none; /* Remove bullet points */
        padding: 0; /* Remove default padding */
      }

      ul li {
        background-color: #f9f9f9; /* Light background for list items */
        margin: 5px 0; /* Space between list items */
        padding: 10px; /* Padding for list items */
        border-radius: 4px; /* Rounded corners */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
        transition: background-color 0.3s; /* Smooth background color transition */
      }

      ul li:hover {
        background-color: #e0f7fa; /* Change background on hover */
      }
      .container ul {
        list-style-type: none; /* Remove bullet points */
        padding: 0; /* Remove padding */
      }

      .container li {
        display: flex; /* Use flexbox for alignment */
        justify-content: space-between; /* Space between text and button */
        align-items: center; /* Center vertically */
        margin-bottom: 10px; /* Space between list items */
      }
      .bookAppointmentBtn {
        background-color: #007bff; /* Primary color for the button */
        color: white; /* Text color */
        border: none; /* No border */
        border-radius: 4px; /* Rounded corners */
        padding: 8px 12px; /* Padding for the button */
        cursor: pointer; /* Pointer cursor on hover */
        transition: background-color 0.3s; /* Smooth background color transition */
      }

      .bookAppointmentBtn:hover {
        background-color: #0056b3; /* Darker shade on hover */
      }
    </style>
  </head>
  <body>
    <header class="header-container">
      <h1>Student Dashboard</h1>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </header>

    <div class="container">
      <h1 id="formTitle">Student Registration</h1>

      <form id="registrationForm" style="display: block">
        <input type="text" id="studentName" placeholder="Name" required />
        <input type="email" id="studentEmail" placeholder="Email" required />
        <input
          type="password"
          id="studentPassword"
          placeholder="Password"
          required
        />
        <button type="submit" class="btnSubmit">Register</button>
      </form>

      <form id="loginForm" style="display: none">
        <input type="email" id="loginEmail" placeholder="Email" required />
        <input
          type="password"
          id="loginPassword"
          placeholder="Password"
          required
        />
        <button type="submit" class="btnSubmit">Login</button>
      </form>

      <p id="toggleMessage" onclick="toggleForms()">
        Already registered? Login here.
      </p>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
      import { getDatabase } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
      import {
        ref,
        push,
        set,
        get,
        remove,
        query,
        orderByChild,
        equalTo,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
      import { child } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBxPGHxAYM1MYb0MVNb2l4c5rB1sp13v8Y",
        authDomain: "student-teacher-booking-16014.firebaseapp.com",
        projectId: "student-teacher-booking-16014",
        storageBucket: "student-teacher-booking-16014.appspot.com",
        messagingSenderId: "109992254488",
        appId: "1:109992254488:web:163c659a769de9d96b776d",
        measurementId: "G-R7E9TGXEGR",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      let currentStudent = null;
      // Function to register a student
      document
        .getElementById("registrationForm")
        ?.addEventListener("submit", function (e) {
          e.preventDefault();
          const name = document.getElementById("studentName").value;
          const email = document.getElementById("studentEmail").value;
          const password = document.getElementById("studentPassword").value;

          const studentData = {
            name,
            email,
            password,
            approved: false,
          };

          const studentsRef = ref(database, "students");
          const newStudentRef = push(studentsRef);
          set(newStudentRef, studentData)
            .then(() => {
              document.getElementById("registrationForm").reset();
              currentStudent = { name, email };
            })
            .catch((error) => {
              console.error("Error submitting registration:", error);
            });
        });

      let currentStudentId;
      document.getElementById("loginForm").onsubmit = function (event) {
        event.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        const studentsRef = ref(database, "students");

        const studentQuery = query(
          studentsRef,
          orderByChild("email"),
          equalTo(email)
        ); // Query to find the student by email
        get(studentQuery)
          .then((snapshot) => {
            if (snapshot.exists()) {
              const student = snapshot.val();
              const studentId = Object.keys(student)[0]; // Get the student ID

              const currentStudentData = student[studentId]; // Access the student's data

              if (currentStudentData.password === password) {
                if (currentStudentData.approved) {
                  alert("Login successful!");
                  currentStudent = currentStudentData; // Store the logged-in student's data
                  currentStudentId = studentId; // Store the student ID

                  const container = document.querySelector(".container");
                  container.innerHTML = `<div class="emptyState">Welcome, ${currentStudent.name}! You are logged in.
                    <button id="searchTeacherBtn" class="btnSubmit2">Search Teacher</button>
                  </div>`;

                  document.getElementById("searchTeacherBtn").onclick =
                    function () {
                      fetchTeachers();
                    };
                } else {
                  alert("Your account is not approved yet.");
                }
              } else {
                alert("Incorrect password.");
              }
            } else {
              alert("No user found with that email.");
            }
          })
          .catch((error) => {
            console.error("Error fetching student data:", error);
          });
      };

      function fetchTeachers() {
        const teachersRef = ref(database, "teachers");
        const appointmentsRef = ref(database, "appointments");

        // Fetch teachers first
        get(teachersRef)
          .then((snapshot) => {
            const teachers = [];
            snapshot.forEach((childSnapshot) => {
              const teacher = childSnapshot.val();
              const teacherId = childSnapshot.key;
              teachers.push({ ...teacher, id: teacherId });
            });

            // Fetch appointments next
            return get(appointmentsRef).then((appointmentsSnapshot) => {
              const appointmentsMap = {};
              appointmentsSnapshot.forEach((childSnapshot) => {
                const appointment = childSnapshot.val();
                if (!appointmentsMap[appointment.teacherId]) {
                  appointmentsMap[appointment.teacherId] = [];
                }
                appointmentsMap[appointment.teacherId].push(appointment);
              });
              return { teachers, appointmentsMap };
            });
          })
          .then(({ teachers, appointmentsMap }) => {
            document.getElementById("searchTeacherBtn").style.display = "none";
            displayTeachers(teachers, appointmentsMap);
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });
      }

      function displayTeachers(teachers, appointmentsMap) {
        const container = document.querySelector(".container");
        let teacherDetailsHtml = "<h2>Teacher List</h2><ul>";

        teachers.forEach((teacher) => {
          const appointments = appointmentsMap[teacher.id] || [];

          let buttonText = "Book Appointment";
          let buttonDisabled = false;

          const requestedAppointment = appointments.find(
            (app) => app.status === "requested"
          );
          const approvedAppointment = appointments.find(
            (app) => app.status === "approved"
          );

          if (approvedAppointment) {
            buttonText = "Approved";
            buttonDisabled = true;
          } else if (requestedAppointment) {
            buttonText = "Request Sent";
            buttonDisabled = true;
          }

          teacherDetailsHtml += `<li>${teacher.name} - ${
            teacher.department
          } - ${teacher.subject}
            <button class="bookAppointmentBtn" data-teacher-id="${
              teacher.id
            }" ${buttonDisabled ? "disabled" : ""}>
                ${buttonText}
            </button>
            </li>`;
        });

        teacherDetailsHtml += "</ul>";
        container.innerHTML += teacherDetailsHtml;

        const buttons = document.querySelectorAll(".bookAppointmentBtn");
        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            const teacherId = button.getAttribute("data-teacher-id");
            const customText = prompt(
              "Enter your custom message for the appointment:"
            );

            if (customText) {
              bookAppointment(teacherId, customText);
              button.textContent = "Request Sent";
              button.disabled = true; // Disable the button after booking
            }
          });
        });
      }

      function bookAppointment(teacherId, customText) {
        const studentName = currentStudent.name; // Get the student's name
        const studentEmail = currentStudent.email; // Get the student's email

        const appointmentData = {
          studentId: currentStudentId, // Replace with actual student ID
          teacherId: teacherId,
          status: "requested", // Initial status
          customMessage: customText,
          studentName: studentName, // Include student's name
          studentEmail: studentEmail, // Include student's email
        };

        const appointmentsRef = ref(database, "appointments");
        const newAppointmentRef = push(appointmentsRef);
        set(newAppointmentRef, appointmentData)
          .then(() => {
            alert("Appointment request sent!");
          })
          .catch((error) => {
            console.error("Error booking appointment:", error);
          });
      }

      // Real-time listener for appointments

      window.logout = function () {
        window.location.href = "index.html"; // Change to your main page
      };
    </script>
    <script>
      function toggleForms() {
        const registrationForm = document.getElementById("registrationForm");
        const loginForm = document.getElementById("loginForm");
        const formTitle = document.getElementById("formTitle");
        const toggleMessage = document.getElementById("toggleMessage");

        if (registrationForm.style.display === "block") {
          registrationForm.style.display = "none";
          loginForm.style.display = "block";
          formTitle.textContent = "Student Login";
          toggleMessage.textContent = "Don't have an account? Register here.";
        } else {
          registrationForm.style.display = "block";
          loginForm.style.display = "none";
          formTitle.textContent = "Student Registration";
          toggleMessage.textContent = "Already registered? Login here.";
        }
      }
    </script>
  </body>
</html>
